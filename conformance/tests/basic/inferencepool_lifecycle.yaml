# conformance/tests/basic/inferencepool_lifecycle.yaml
# This file includes both the InferencePool and the HTTPRoute

# --- InferencePool Definition ---
apiVersion: inference.networking.x-k8s.io/v1alpha2
kind: InferencePool
metadata:
  # This name must match the 'poolName' variable defined in the
  # conformance/tests/basic/inferencepool_lifecycle_test.go test file.
  name: inferencepool-lifecycle-test
  # This namespace should be one created by the base manifests and 
  # match the conformance/tests/basic/inferencepool_lifecycle_test.go test file.
  namespace: gateway-conformance-infra
spec:
  # --- Selector (Required) ---
  # Selects the Pods belonging to this pool.
  # This 'app' label value must match what is asserted in the Go test.
  selector:
    app: "lifecycle-test-app"

  # --- Target Port (Required) ---
  # The port the model server container listens on.
  targetPortNumber: 3000

  # --- Extension Reference (Required) ---
  # Configuration for the Endpoint Picker.
  extensionRef:
    # group: "" # Optional, defaults to "" (core API group)
    # kind: Service # Optional, defaults to "Service"
    name: infra-backend-v1-epp
    # portNumber: 1234 # Optional
    # failureMode: "FailClose" # Optional, defaults to "FailClose"

---
# --- HTTPRoute Definition ---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httproute-for-inferencepool-lifecycle-test
  # HTTPRoute is now also in the 'default' namespace for this test.
  namespace: gateway-conformance-infra
spec:
  parentRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: test-gateway # Name of the shared Gateway
    namespace: gateway-conformance-infra  # Namespace of the shared Gateway
    sectionName: http # Assuming the shared Gateway has an HTTP listener named 'http'
  rules:
  - backendRefs:
    - group: inference.networking.k8s.io # Your InferencePool API group
      kind: InferencePool
      name: inferencepool-basic-accepted # Name of the InferencePool this route points to
      # Namespace for backendRef is omitted as HTTPRoute and InferencePool are in the same namespace ('default')
    matches:
    - path:
        type: PathPrefix
        value: /accepted-pool-test
