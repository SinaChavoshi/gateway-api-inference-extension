---
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: primary-pool-health-check
  namespace: gateway-conformance-app-backend
spec:
  targetRef:
    group: "inference.networking.x-k8s.io"
    kind: InferencePool
    name: pool-primary
  default:
    config:
      type: HTTP
      httpHealthCheck:
          requestPath: /
          port: 3000
---
apiVersion: networking.gke.io/v1
kind: HealthCheckPolicy
metadata:
  name: secondary-pool-health-check
  namespace: gateway-conformance-app-backend
spec:
  targetRef:
    group: "inference.networking.x-k8s.io"
    kind: InferencePool
    name: pool-secondary
  default:
    config:
      type: HTTP
      httpHealthCheck:
          requestPath: /
          port: 3000
---
apiVersion: inference.networking.x-k8s.io/v1alpha2
kind: InferencePool
metadata:
  name: pool-primary
  namespace: gateway-conformance-app-backend
spec:
  selector:
    app: inference-model-1
  targetPortNumber: 3000
  extensionRef:
    name: conformance-epp-service
    portNumber: 9002
---
apiVersion: inference.networking.x-k8s.io/v1alpha2
kind: InferencePool
metadata:
  name: pool-secondary
  namespace: gateway-conformance-app-backend
spec:
  selector:
    app: inference-model-2
  targetPortNumber: 3000
  extensionRef:
    name: conformance-epp-service
    portNumber: 9002
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: httproute-multiple-rules-different-pools
  namespace: gateway-conformance-app-backend
spec:
  parentRefs:
    - name: conformance-gateway
      namespace: gateway-conformance-infra
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /primary
      backendRefs:
        - name: pool-primary
          kind: InferencePool
          group: inference.networking.x-k8s.io
          port: 80
    - matches:
        - path:
            type: PathPrefix
            value: /secondary
      backendRefs:
        - name: pool-secondary
          kind: InferencePool
          group: inference.networking.x-k8s.io
          port: 80
